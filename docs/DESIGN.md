# World Demo â€” Design Document

> A simplified xianxia cultivation RPG demo with AI-powered NPCs.

## Decisions

| Question | Answer |
|---|---|
| Perspective | 2D top-down |
| Engine | **Godot 4** (GDScript) |
| Art style | Anime-style (flexible, swappable later) |
| Platform | PC only |
| Player mode | Solo (team formation with NPCs planned for later) |

## Core Pillars

1. **NPC Generation** â€” procedural character + portrait creation
2. **NPC Relationships & Social** â€” favorability, contact history, autonomous NPC-NPC interactions
3. **NPC Chat** â€” free-form LLM-powered conversation with context

---

## 1. NPC Generation

### 1.1 Character Profile Generation

Each NPC is generated from **random picks out of predefined pools** combined into a prompt sent to the LLM for a cohesive profile.

**Attribute pools:**

| Attribute | Pool examples |
|---|---|
| Name | Generated by LLM (Chinese xianxia-style names) |
| Age | 16â€“200 (weighted toward younger for "school" setting) |
| Gender | Male, Female |
| Cultivation Realm | ç»ƒæ°” (Qi Refining), ç­‘åŸº (Foundation), é‡‘ä¸¹ (Core Formation) |
| Elemental Affinity | Fire ğŸ”¥, Water ğŸ’§, Wood ğŸŒ¿, Metal âš”ï¸, Earth ğŸª¨ |
| Personality Traits | 2â€“3 picked from pool: brave, cunning, shy, hot-headed, scholarly, lazy, kind, arrogant, mysterious, cheerful |
| Backstory Tags | orphan, noble family, wandering, sect disciple, self-taught, exiled |

**Generation flow:**
1. Randomly sample from each attribute pool
2. Send sampled attributes to LLM with a system prompt: *"Generate a short xianxia character profile given these traits..."*
3. LLM returns: `name`, `backstory` (2-3 sentences), `speaking_style` (used for chat personality)
4. Store as NPC config (JSON/Resource)

**NPC Config structure:**
```json
{
  "id": "npc_001",
  "name": "æ—æ¸…éœœ",
  "age": 19,
  "gender": "Female",
  "realm": "ç­‘åŸº (Foundation)",
  "element": "Water",
  "personality": ["scholarly", "shy"],
  "backstory_tags": ["noble family"],
  "backstory": "Born into the Lin family of Azure Lake...",
  "speaking_style": "Polite, uses classical idioms, avoids direct confrontation",
  "portrait_prompt": "anime girl, blue robes, long black hair, gentle expression, water element, xianxia",
  "portrait_path": "res://assets/portraits/npc_001.png"
}
```

### 1.2 Portrait Generation

- Use **Gemini Pro 3** image generation API
- Build prompt from character attributes: gender + element color + personality vibe + xianxia clothing
- Download and cache the generated image locally
- Fallback: placeholder sprite if API fails

**Prompt template:**
```
anime portrait, {gender}, {age_description}, {element} color theme,
xianxia robes, {personality_vibe}, detailed face, clean background
```

---

## 2. NPC Relationships & Social

### 2.1 Relationship Data

Each NPC pair has a relationship record:

```json
{
  "npc_a": "npc_001",
  "npc_b": "npc_002",
  "favorability": 50,
  "relationship_type": "classmate",
  "contact_history": [
    {"type": "talk", "timestamp": "day_3", "summary": "Discussed cultivation techniques"},
    {"type": "gift", "timestamp": "day_5", "summary": "Player gave a healing pill"}
  ]
}
```

**Favorability scale:** 0â€“100
- 0â€“20: Hostile
- 21â€“40: Cold
- 41â€“60: Neutral
- 61â€“80: Friendly
- 81â€“100: Close / Devoted

### 2.2 Player â†’ NPC Interactions

When the player clicks an NPC, a panel opens with:

1. **Profile card** â€” portrait, name, realm, element, personality, current favorability
2. **Action choices:**
   - **Chat** â€” opens free-form LLM chat (see Section 3)
   - **Gift** â€” give an item (affects favorability)
   - **Spar** â€” friendly combat challenge (placeholder / simple dice roll for demo)
   - **Ask about others** â€” NPC gives opinion on another NPC (LLM-generated)
3. **Chat tab** â€” full conversation history with this NPC

### 2.3 NPC â†” NPC Autonomous Interactions (Round-Based)

The player clicks a **"Next Round"** button to advance the world. Each round:

1. Pick 2â€“3 random NPC pairs
2. Roll a random interaction type from a weighted table:
   | Interaction | Weight | Favorability Change |
   |---|---|---|
   | Friendly chat | 30% | +2 |
   | Train together | 20% | +3 |
   | Argue | 15% | -3 |
   | Ignore each other | 20% | -1 |
   | Share a meal | 10% | +4 |
   | Compete / rivalry | 5% | -2 |
3. Apply favorability change to both NPCs
4. Generate a summary from **templates** (no LLM call), e.g.:
   - *"{npc_a} and {npc_b} had a friendly chat about sword forms (+2)"*
   - *"{npc_a} argued with {npc_b} over training methods (-3)"*
5. Show results in the **notification log**

**No LLM is used here** â€” purely random + rule-based. This keeps costs zero and response instant.

---

## 3. NPC Chat System

### 3.1 LLM Integration Layer

**Flexible provider abstraction:**

```
LLMProvider (interface)
â”œâ”€â”€ ClaudeProvider    â€” Anthropic Claude API
â”œâ”€â”€ OpenAIProvider    â€” OpenAI GPT API
â”œâ”€â”€ GeminiProvider    â€” Google Gemini API
â””â”€â”€ (extensible)
```

Each provider implements:
- `chat(system_prompt, messages[]) -> response`
- `generate_profile(attributes) -> profile_json`

Config file selects which provider to use:
```json
{
  "chat_provider": "claude",
  "profile_provider": "claude",
  "image_provider": "gemini",
  "api_keys": {
    "claude": "sk-...",
    "openai": "sk-...",
    "gemini": "..."
  }
}
```

### 3.2 Chat Context Management

Each conversation sends the LLM:

1. **System prompt** â€” built from NPC config:
   ```
   You are {name}, a {realm} cultivator with {element} affinity.
   Personality: {personality}. Backstory: {backstory}.
   Speaking style: {speaking_style}.
   Current favorability toward the player: {favorability}/100.
   Respond in character. Keep responses under 3 sentences.
   ```

2. **Conversation history** â€” last N messages (sliding window, default 20)

3. **Relationship context** â€” injected as a system note:
   ```
   [Context: You recently {last_interaction} with the player.
   You feel {favorability_descriptor} toward them.]
   ```

4. **Player message** â€” the user's free-form input

### 3.3 Chat Effects

After each chat exchange, optionally:
- Adjust favorability (Â±1â€“3) based on LLM sentiment analysis or simple keyword matching
- Log the interaction in contact history
- Unlock new dialogue options if favorability crosses a threshold

---

## 4. Scene & Map

### 4.1 Demo Scene: NPC Selection Bar

No movement in this version. All NPCs are displayed as **face portrait thumbnails** in a horizontal bar at the top of the screen. Click a face to select that NPC.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ğŸ˜€NPC1] [ğŸ˜€NPC2] [ğŸ˜€NPC3] [ğŸ˜€NPC4] [ğŸ˜€NPC5]  â”‚  â† face crops, clickable
â”‚  æ—æ¸…éœœ    èµµæ— æ    ç™½ç‰äº¬    æ²ˆå¢¨     æŸ³å¦‚çƒŸ     â”‚  â† names below each face
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Each thumbnail is a cropped face from the generated portrait
- Hovering shows NPC name + realm as tooltip
- Clicking opens the NPC panel below
- Selected NPC has a highlight border
- No map, no movement â€” purely UI-driven interaction

### 4.2 UI Layout (Left-Right Split)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ğŸ˜€NPC1] [ğŸ˜€NPC2] [ğŸ˜€NPC3] [ğŸ˜€NPC4] [ğŸ˜€NPC5]  [Next â–¶]â”‚
â”‚  æ—æ¸…éœœ    èµµæ— æ    ç™½ç‰äº¬    æ²ˆå¢¨     æŸ³å¦‚çƒŸ     Round   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        â”‚  Name: æ—æ¸…éœœ                    â”‚
â”‚                        â”‚  Realm: ç­‘åŸº (Foundation)        â”‚
â”‚                        â”‚  Element: Water ğŸ’§               â”‚
â”‚                        â”‚  Personality: scholarly, shy     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  Favorability: â™¥â™¥â™¥â™¡â™¡ (62/100)  â”‚
â”‚    â”‚              â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚    â”‚   LARGE      â”‚    â”‚ [Chat] [Gift] [Spar] [Ask About]â”‚
â”‚    â”‚   PORTRAIT   â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚    â”‚              â”‚    â”‚ > You: Hi, how's training?       â”‚
â”‚    â”‚              â”‚    â”‚ > æ—æ¸…éœœ: The water technique     â”‚
â”‚    â”‚              â”‚    â”‚   requires patience. I've been   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   practicing by the lake.        â”‚
â”‚                        â”‚                                  â”‚
â”‚                        â”‚                                  â”‚
â”‚                        â”‚ [Type message here...]    [Send] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Notification Log:                                        â”‚
â”‚  â–¸ Round 3: èµµæ— æ trained with ç™½ç‰äº¬ (+3 favorability)  â”‚
â”‚  â–¸ Round 3: æ—æ¸…éœœ argued with æ²ˆå¢¨ (-3 favorability)     â”‚
â”‚  â–¸ Round 2: æŸ³å¦‚çƒŸ shared a meal with èµµæ— æ (+4)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Layout breakdown:**
- **Top bar**: NPC face thumbnails + "Next Round" button
- **Left panel (~40%)**: Large NPC portrait image
- **Right panel (~60%)**: NPC profile info + action buttons + chat area
- **Bottom bar**: Notification log showing round-by-round NPC-NPC interaction results

---

## 5. Godot Project Structure

```
world-demo/
â”œâ”€â”€ project.godot
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ llm_config.json          # API keys + provider selection
â”‚   â””â”€â”€ npc_pools.json           # Attribute pools for generation
â”œâ”€â”€ scenes/
â”‚   â”œâ”€â”€ main.tscn                # Entry scene (contains full UI layout)
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ npc_panel.tscn           # Profile + chat panel
â”‚   â”œâ”€â”€ notification_log.tscn    # Event feed
â”‚   â””â”€â”€ hud.tscn                 # Top-level UI
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ npc/
â”‚   â”‚   â”œâ”€â”€ npc.gd               # NPC node logic
â”‚   â”‚   â”œâ”€â”€ npc_generator.gd     # Profile generation from pools + LLM
â”‚   â”‚   â”œâ”€â”€ npc_data.gd          # NPC data resource class
â”‚   â”‚   â””â”€â”€ relationship.gd      # Relationship tracking
â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”œâ”€â”€ llm_manager.gd       # Provider abstraction + request queue
â”‚   â”‚   â”œâ”€â”€ claude_provider.gd   # Claude API implementation
â”‚   â”‚   â”œâ”€â”€ openai_provider.gd   # OpenAI API implementation
â”‚   â”‚   â””â”€â”€ gemini_provider.gd   # Gemini API implementation
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ chat_manager.gd      # Context building, history management
â”‚   â”‚   â””â”€â”€ chat_effects.gd      # Post-chat favorability updates
â”‚   â””â”€â”€ world/
â”‚       â”œâ”€â”€ round_manager.gd     # "Next Round" logic â€” random NPC-NPC interactions
â”‚       â””â”€â”€ interaction_log.gd   # Notification/event log
â””â”€â”€ assets/
    â”œâ”€â”€ portraits/               # Generated/cached NPC portraits
    â”œâ”€â”€ thumbnails/              # Cropped face thumbnails for top bar
    â””â”€â”€ ui/                      # UI theme assets
```

---

## 6. Demo Prototype Scope

**What the prototype includes:**

- [x] NPC face thumbnail bar â€” click to select NPC
- [x] 5â€“8 NPCs generated at game start via LLM
- [x] NPC portraits generated via Gemini Pro 3
- [x] Left-right split UI: large portrait (left) + profile & chat (right)
- [x] Click NPC â†’ profile card with portrait, stats, favorability
- [x] Free-form chat with NPC (LLM-powered, context-aware)
- [x] Action buttons: Chat, Gift, Spar (dice roll), Ask About Others
- [x] Favorability system that changes based on interactions
- [x] "Next Round" button â€” rule-based NPC-NPC interactions (no LLM)
- [x] Notification log showing round results
- [x] Flexible LLM provider (swap between Claude/OpenAI/Gemini)

**What is deferred:**

- Player movement / explorable map
- Combat system beyond dice-roll spar
- Multiple maps / exploration
- Cultivation progression (leveling up realms)
- Inventory / items beyond simple gifts
- Team formation
- Save/load system
- Sound / music

---

## 7. API Call Budget Considerations

LLM API calls can be expensive. Strategies to manage costs:

1. **Profile generation**: One-time per NPC at world creation (~8 calls)
2. **Image generation**: One-time per NPC (~8 calls to Gemini)
3. **Chat**: Per player interaction (most frequent cost â€” consider caching or shorter context)
4. **NPC-NPC autonomous**: Use **templates** for common interactions, only call LLM for unique/important ones (e.g., 1 in 5 interactions uses LLM, rest use templates)
5. **Rate limiting**: Queue requests, max 1 concurrent LLM call

---

*Ready to implement. Next step: set up Godot project and build the NPC generation pipeline.*
